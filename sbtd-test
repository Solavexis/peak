local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")
local LP = Players.LocalPlayer

local PLACE_MAIN = 93249115521759
local MAP_PLACE_ID = 124546322564930

local SpawnTower
local SellTower

if game.PlaceId == MAP_PLACE_ID then
    local Functions = ReplicatedStorage:WaitForChild("Functions")
    SpawnTower = Functions:WaitForChild("SpawnTower")
    SellTower = Functions:WaitForChild("SellTower")
end

_G.mapname = "Valentines2" -- map name (if Valentines then it's called Valentines2)
_G.needtower = "Trophy, Engineer, Buddy, Sun" -- tower needed
_G.preciseTiming = true -- don't change if you don't know what you're doing
_G.url = "https://raw.githubusercontent.com/Solavexis/peak/refs/heads/main/sbtd-test" -- (NEEDED for replaying, (NEEDED TO BE RAW) example of text host site: pastebin, github (need account but a bit more organized) and etc.)
-- example of url: pastebin: https://pastebin.com/raw/ the string, github: https://raw.githubusercontent.com/ username / repo /refs/heads/main/ nameofthefile

local function equipNeededTowers()
	local pg = LP:WaitForChild("PlayerGui",5) if not pg then return end
	local shop = pg:WaitForChild("ShopGui",5) if not shop then return end
	local inv = shop:WaitForChild("Inventory",5) if not inv then return end
	for _,item in string.split(_G.needtower,",") do
		local t = item:match("^%s*(.-)%s*$")
		if t ~= "" and not inv:FindFirstChild(t) then
			ReplicatedStorage:WaitForChild("InteractItem"):InvokeServer(t)
			task.wait(.4)
		end
	end
end

local function queueScript()
	if syn and syn.queue_on_teleport then
		syn.queue_on_teleport('loadstring(game:HttpGet("'.._G.url..'"))()')
	elseif queue_on_teleport then
		queue_on_teleport('loadstring(game:HttpGet("'.._G.url..'"))()')
	end
end
queueScript()

local function touchFinish()
	local obby = workspace:FindFirstChild("Obby") if not obby then return end
	local finish = obby:FindFirstChild("Finish") if not finish then return end
	local hrp = LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end
	firetouchinterest(hrp,finish,0) task.wait() firetouchinterest(hrp,finish,1)
end

local function teleport(id)
	if game.PlaceId ~= id then game:GetService("TeleportService"):Teleport(id,LP) end
end

local function tp()
	ReplicatedStorage.Party.Teleport:InvokeServer(_G.mapname,true)
end

LP.Idled:Connect(function()
	VirtualUser:CaptureController()
	VirtualUser:ClickButton2(Vector2.new())
end)

local function findNearestTower(name,cf)
	local closest,dist=nil,math.huge
	for _,v in workspace.Towers:GetChildren() do
		if v.Name==name then
			local d=(v:GetPivot().Position-cf.Position).Magnitude
			if d<dist then dist=d closest=v end
		end
	end
	return closest
end

local function parseCF(str)
	local n={}
	for x in str:gmatch("-?[%d%.]+") do n[#n+1]=tonumber(x) end
	if #n<3 then return nil end
	return CFrame.new(n[1],n[2],n[3])
end

local placedTowers = {}

local actions = {
    {Action = "Spawn", Name = "Trophy", Index = 1, CFrameStr = "CFrame.new(-68.643997192,159.242370605,39.720848083)", Timestamp = 7},
    {Action = "Spawn", Name = "Trophy", Index = 2, CFrameStr = "CFrame.new(-72.544265747,159.011474609,41.400108337)", Timestamp = 9.547235},
    {Action = "Spawn", Name = "Trophy", Index = 3, CFrameStr = "CFrame.new(-71.603073120,158.948013306,38.019348145)", Timestamp = 11.64722},
    {Action = "Upgrade", Name = "Winner", Index = 1, CFrameStr = "CFrame.new(-68.635086060,158.526168823,39.718742371)", Timestamp = 20.628952},
    {Action = "Upgrade", Name = "Winner", Index = 2, CFrameStr = "CFrame.new(-72.544265747,159.011474609,41.400108337)", Timestamp = 32.887267},
    {Action = "Upgrade", Name = "Award", Index = 1, CFrameStr = "CFrame.new(-68.628822327,158.526229858,39.721885681)", Timestamp = 63.091278},
    {Action = "Upgrade", Name = "Award", Index = 2, CFrameStr = "CFrame.new(-72.544265747,158.526824951,41.400108337)", Timestamp = 73.173211},
    {Action = "Sell", Name = "Trophy", Index = 3,  CFrameStr = "CFrame.new(-71.603073120,158.526824951,38.019348145)", Timestamp = 86.361665},
    {Action = "Upgrade", Name = "Bloxy", Index = 1, CFrameStr = "CFrame.new(-68.628814697,158.526824951,39.721878052)", Timestamp = 96.92925},
    {Action = "Upgrade", Name = "Bloxy", Index = 2, CFrameStr = "CFrame.new(-72.544265747,158.526855469,41.400108337)", Timestamp = 102.658388},
    {Action = "Spawn", Name = "Sun", Index = 4, CFrameStr = "CFrame.new(-42.246223450,159.044448853,35.313236237)", Timestamp = 114.623344},
    {Action = "Upgrade", Name = "Solarflare", Index = 4, CFrameStr = "CFrame.new(-42.246223450,158.605804443,35.313236237)", Timestamp = 124.493784},
    {Action = "Spawn", Name = "Engineer", Index = 5, CFrameStr = "CFrame.new(-44.508575439,159.513259888,33.568614960)", Timestamp = 129.789201},
    {Action = "Upgrade", Name = "Technician", Index = 5, CFrameStr = "CFrame.new(-44.509216309,158.786773682,33.568248749)", Timestamp = 131.070019},
    {Action = "Upgrade", Name = "Neutronstar", Index = 4, CFrameStr = "CFrame.new(-42.246223450,158.579208374,35.313236237)", Timestamp = 147.025269},
    {Action = "Spawn", Name = "Buddy", Index = 6, CFrameStr = "CFrame.new(-43.011516571,159.000869751,38.076225281)", Timestamp = 155.973111},
    {Action = "Upgrade", Name = "Best Buddy", Index = 6, CFrameStr = "CFrame.new(-43.011516571,158.613510132,38.076225281)", Timestamp = 157.209458},
    {Action = "Spawn", Name = "Buddy", Index = 7, CFrameStr = "CFrame.new(-42.909595490,159.209915161,37.420425415)", Timestamp = 159.023634},
    {Action = "Upgrade", Name = "Best Buddy", Index = 7, CFrameStr = "CFrame.new(-42.897392273,158.526855469,37.427532196)", Timestamp = 160.122844},
    {Action = "Spawn", Name = "Buddy", Index = 8, CFrameStr = "CFrame.new(-42.344188690,158.885055542,37.722095490)", Timestamp = 161.956551},
    {Action = "Upgrade", Name = "Best Buddy", Index = 8, CFrameStr = "CFrame.new(-42.344188690,158.613510132,37.722095490)", Timestamp = 163.156482},
    {Action = "Spawn", Name = "Buddy", Index = 9, CFrameStr = "CFrame.new(-42.857677460,159.181167603,37.720798492)", Timestamp = 164.793714},
    {Action = "Upgrade", Name = "Best Buddy", Index = 9, CFrameStr = "CFrame.new(-42.856605530,158.612518311,37.720031738)", Timestamp = 165.883856},
    {Action = "Spawn", Name = "Buddy", Index = 10, CFrameStr = "CFrame.new(-42.393989563,159.086013794,37.658462524)", Timestamp = 167.189895},
    {Action = "Upgrade", Name = "Best Buddy", Index = 10, CFrameStr = "CFrame.new(-42.407382965,158.612503052,37.649719238)", Timestamp = 168.343581},
    {Action = "Spawn", Name = "Buddy", Index = 11, CFrameStr = "CFrame.new(-42.521705627,159.082550049,37.561332703)", Timestamp = 169.788767},
    {Action = "Upgrade", Name = "Best Buddy", Index = 11, CFrameStr = "CFrame.new(-42.521705627,158.526855469,37.561332703)", Timestamp = 170.942363},
    {Action = "Upgrade", Name = "Redstar", Index = 4, CFrameStr = "CFrame.new(-42.246223450,158.586425781,35.313236237)", Timestamp = 191.991008},
    {Action = "Spawn", Name = "Sun", Index = 12, CFrameStr = "CFrame.new(-42.683181763,159.050476074,34.404029846)", Timestamp = 242.438278},
    {Action = "Upgrade", Name = "Solarflare", Index = 12, CFrameStr = "CFrame.new(-42.683181763,158.578079224,34.404029846)", Timestamp = 243.933809},
    {Action = "Upgrade", Name = "Neutronstar", Index = 12, CFrameStr = "CFrame.new(-42.683181763,158.578079224,34.404029846)", Timestamp = 244.983324},
    {Action = "Upgrade", Name = "Redstar", Index = 12, CFrameStr = "CFrame.new(-42.683181763,158.578079224,34.404029846)", Timestamp = 246.365063},
    {Action = "Upgrade", Name = "Star", Index = 12, CFrameStr = "CFrame.new(-42.683181763,158.708038330,34.404029846)", Timestamp = 263.18913},
    {Action = "Spawn", Name = "Sun", Index = 13, CFrameStr = "CFrame.new(-41.501571655,159.219726562,36.407993317)", Timestamp = 266.362974},
    {Action = "Upgrade", Name = "Solarflare", Index = 13, CFrameStr = "CFrame.new(-41.501571655,158.605804443,36.407993317)", Timestamp = 267.881119},
    {Action = "Upgrade", Name = "Neutronstar", Index = 13, CFrameStr = "CFrame.new(-41.501571655,158.605804443,36.407993317)", Timestamp = 269.047745},
    {Action = "Upgrade", Name = "Redstar", Index = 13, CFrameStr = "CFrame.new(-41.501571655,158.601791382,36.407993317)", Timestamp = 277.841439},
    {Action = "Upgrade", Name = "Star", Index = 13, CFrameStr = "CFrame.new(-41.501571655,158.509552002,36.407993317)", Timestamp = 281.013284},
    {Action = "Sell", Name = "Bloxy", Index = 1, CFrameStr = "CFrame.new(-68.628814697,158.526824951,39.721878052)", Timestamp = 286.445329},
    {Action = "Sell", Name = "Bloxy", Index = 2, CFrameStr = "CFrame.new(-72.544265747,158.526824951,41.400108337)", Timestamp = 288.480087},
    {Action = "Upgrade", Name = "Bluestar", Index = 4, CFrameStr = "CFrame.new(-42.246223450,158.975418091,35.313236237)", Timestamp = 296.826609},
    {Action = "Upgrade", Name = "Bluestar", Index = 12, CFrameStr = "CFrame.new(-42.683181763,158.776596069,34.404029846)", Timestamp = 320.765683},
    {Action = "Upgrade", Name = "Nova", Index = 12, CFrameStr = "CFrame.new(-42.683181763,158.716445923,34.404029846)", Timestamp = 357.090845},
    {Action = "Upgrade", Name = "Bluestar", Index = 13, CFrameStr = "CFrame.new(-41.501571655,158.576522827,36.407993317)", Timestamp = 368.26401},
    {Action = "Upgrade", Name = "Nova", Index = 4, CFrameStr = "CFrame.new(-42.246223450,158.915176392,35.313236237)", Timestamp = 384.289215},
    {Action = "Upgrade", Name = "Nova", Index = 13, CFrameStr = "CFrame.new(-41.501571655,158.511459351,36.407993317)", Timestamp = 399.90556},
    {Action = "Upgrade", Name = "Supernova", Index = 12, CFrameStr = "CFrame.new(-42.683181763,158.761550903,34.404029846)", Timestamp = 422.646337},
    {Action = "Upgrade", Name = "Supernova", Index = 4, CFrameStr = "CFrame.new(-42.246223450,158.902770996,35.313236237)", Timestamp = 436.941536},
    {Action = "Upgrade", Name = "Supernova", Index = 13, CFrameStr = "CFrame.new(-41.501571655,158.505844116,36.407993317)", Timestamp = 444.925394},
}

local function replay()
	if #actions == 0 then return end
	local shift = 7 - actions[1].Timestamp
	local start = workspace.DistributedGameTime

	for _, a in ipairs(actions) do
		local target = start + a.Timestamp + shift
		while workspace.DistributedGameTime < target do
			RunService.Heartbeat:Wait()
		end

		local cf = parseCF(a.CFrameStr)
		if not cf then continue end

		local key = tostring(cf.Position)
		if a.Action == "Spawn" then
        	SpawnTower:InvokeServer(a.Name, cf)
        	task.wait(0.25)
        	local tower = findNearestTower(a.Name, cf)
        	if tower then
	        	placedTowers[a.Index] = tower
        	end

        elseif a.Action == "Sell" then
        	local tower = placedTowers[a.Index]
        	if tower then
		        SellTower:InvokeServer(tower)
        		placedTowers[a.Index] = nil
        	end

        elseif a.Action == "Upgrade" then
        	local old = placedTowers[a.Index]
        	if old then
		        SpawnTower:InvokeServer(a.Name, cf, old)
	        	task.wait(0.3)
	        	local newTower = findNearestTower(a.Name, cf)
	        	if newTower then
		        	placedTowers[a.Index] = newTower
	        	end
        	end
        end
	end
end

task.spawn(function()
	while task.wait(2) do
		local id = game.PlaceId
		if id == MAP_PLACE_ID then
			local pg = LP.PlayerGui
			if pg and pg:FindFirstChild("GameGui") then
				local exit = pg.GameGui:FindFirstChild("Exit")
				if exit and exit.Visible then
					teleport(PLACE_MAIN)
				end
			end
		elseif id == PLACE_MAIN then
			touchFinish()
			equipNeededTowers()
			task.wait(2.5)
			tp()
			task.delay(90, function()
				if game.PlaceId == PLACE_MAIN then tp() end
			end)
		end
	end
end)

if game.PlaceId == MAP_PLACE_ID then
	replay()
end

print("Macro loaded | Map: ".._G.mapname)
